<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MUJER — Ropa de mujer de segunda (CDMX)</title>
  <meta name="description" content="Compra y vende ropa de mujer de segunda mano en CDMX. Seguro, fácil y con pago protegido. Lanzamiento local."/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <style>
    html { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    .chip { @apply text-xs px-2 py-1 rounded-full bg-zinc-100 text-zinc-700; }
    .btn { @apply px-4 py-2 rounded-xl text-sm font-semibold; }
    .btn-primary { @apply bg-rose-600 text-white hover:bg-rose-700; }
    .btn-ghost { @apply bg-white border border-zinc-300 hover:bg-zinc-50; }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <!-- NAV -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b border-zinc-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-zinc-900 text-white grid place-items-center font-bold">M</div>
        <div class="font-bold text-lg">MUJER · Ropa de segunda</div>
        <span class="ml-3 chip">CDMX · Lanzamiento</span>
      </div>
      <nav class="flex items-center gap-2">
        <button id="btnFeed" class="px-3 py-2 rounded-lg hover:bg-zinc-100 text-sm font-medium">Explorar</button>
        <button id="btnPublish" class="px-3 py-2 rounded-lg hover:bg-zinc-100 text-sm font-medium">Publicar</button>
        <button id="btnMyAccount" class="px-3 py-2 rounded-lg hover:bg-zinc-100 text-sm font-medium">Mi cuenta</button>
        <button id="btnAdmin" class="px-3 py-2 rounded-lg hover:bg-zinc-100 text-sm font-medium">Admin</button>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section class="bg-white border-b border-zinc-200">
    <div class="max-w-6xl mx-auto px-4 py-12 grid md:grid-cols-2 gap-10 items-center">
      <div>
        <h1 class="text-4xl font-extrabold leading-tight">Ropa de mujer de segunda — fácil, segura y con estilo</h1>
        <p class="mt-3 text-zinc-600">Arrancamos en CDMX. Publica en 2 minutos, vende sin regateos y cobra cuando tu compradora confirme la entrega. Entrega en persona o envío.</p>
        <div class="mt-6 flex gap-3">
          <button id="ctaExplorar" class="btn btn-primary">Explorar</button>
          <button id="ctaPublicar" class="btn btn-ghost">Publicar prenda</button>
        </div>
        <div class="mt-6 grid sm:grid-cols-3 gap-3 text-sm">
          <div class="p-3 rounded-xl bg-rose-50 border border-rose-100">
            <div class="font-semibold">Pago protegido</div>
            <div class="text-zinc-600">Escrow manual en esta versión.</div>
          </div>
          <div class="p-3 rounded-xl bg-rose-50 border border-rose-100">
            <div class="font-semibold">Entrega simple</div>
            <div class="text-zinc-600">En persona o por paquetería.</div>
          </div>
          <div class="p-3 rounded-xl bg-rose-50 border border-rose-100">
            <div class="font-semibold">Solo ropa de mujer</div>
            <div class="text-zinc-600">Enfoque y comunidad clara.</div>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div class="aspect-square rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1520975979642-6453be3f7070?q=80&w=600&auto=format&fit=crop" alt="Vestidos" class="h-full w-full object-cover"/></div>
        <div class="aspect-square rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=600&auto=format&fit=crop" alt="Tops" class="h-full w-full object-cover"/></div>
        <div class="aspect-square rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1541096017664-732c0cda1f07?q=80&w=600&auto=format&fit=crop" alt="Abrigos" class="h-full w-full object-cover"/></div>
        <div class="col-span-3 aspect-[3/1] rounded-2xl overflow-hidden shadow-sm"><img src="https://images.unsplash.com/photo-1534297635766-a262cdcb81b8?q=80&w=1200&auto=format&fit=crop" alt="Moda mujer" class="h-full w-full object-cover"/></div>
      </div>
    </div>
  </section>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 py-10">
    <!-- Filtros -->
    <div class="flex flex-wrap items-center gap-3 mb-6">
      <select id="filterSubcat" class="px-3 py-2 rounded-xl border border-zinc-300 bg-white text-sm">
        <option value="">Tipo: Todos</option>
        <option>Tops</option>
        <option>Vestidos</option>
        <option>Pantalones</option>
        <option>Faldas</option>
        <option>Abrigos</option>
        <option>Conjuntos</option>
      </select>
      <select id="filterCity" class="px-3 py-2 rounded-xl border border-zinc-300 bg-white text-sm">
        <option value="">Ciudad: Todas</option>
        <option>CDMX</option>
        <option>Guadalajara</option>
        <option>Monterrey</option>
      </select>
      <select id="filterOrder" class="px-3 py-2 rounded-xl border border-zinc-300 bg-white text-sm">
        <option value="new">Orden: Recientes</option>
        <option value="price_asc">Precio: menor a mayor</option>
        <option value="price_desc">Precio: mayor a menor</option>
      </select>
      <div class="relative">
        <input id="searchInput" type="search" placeholder="Buscar prenda, marca…" class="pl-10 pr-3 py-2 rounded-xl border border-zinc-300 bg-white text-sm min-w-[240px]">
        <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
      </div>
      <button id="clearFilters" class="px-3 py-2 rounded-xl bg-zinc-100 text-sm">Limpiar</button>
    </div>

    <!-- Grid de productos -->
    <div id="grid" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

    <!-- Empty state -->
    <div id="emptyState" class="hidden text-center text-zinc-600 py-16">
      <p>Sin resultados. Prueba limpiar filtros.</p>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="mt-8 border-t border-zinc-200">
    <div class="max-w-6xl mx-auto px-4 py-8 text-sm text-zinc-500 flex flex-wrap items-center justify-between gap-3">
      <p>© <span id="year"></span> MUJER — CDMX</p>
      <div class="flex items-center gap-3">
        <a href="#" class="hover:underline">Términos</a>
        <a href="#" class="hover:underline">Privacidad</a>
        <a href="#" id="openSettings" class="hover:underline">Ajustes</a>
      </div>
    </div>
  </footer>

  <!-- MODAL: Publicar -->
  <div id="modalPublish" class="hidden fixed inset-0 z-50 bg-black/40 p-4 overflow-y-auto">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl p-6 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold">Publicar prenda — Ropa de mujer</h3>
        <button class="text-zinc-500 hover:text-zinc-800" onclick="closeModal('modalPublish')">✕</button>
      </div>
      <form id="publishForm" class="grid md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <div>
            <label class="text-sm font-medium">Título</label>
            <input required id="pTitle" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Ej. Vestido midi floral" />
          </div>
          <div>
            <label class="text-sm font-medium">Tipo</label>
            <select required id="pSubcat" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300">
              <option>Tops</option>
              <option>Vestidos</option>
              <option>Pantalones</option>
              <option>Faldas</option>
              <option>Abrigos</option>
              <option>Conjuntos</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Talla</label>
            <select id="pSize" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300">
              <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option>
            </select>
          </div>
          <div>
          <div>
            <label class="text-sm font-medium">Condición</label>
            <select id="pCondition" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300">
              <option value="Nuevo">Nuevo</option>
              <option value="Casi nuevo">Casi nuevo</option>
              <option value="Con uso">Con uso</option>
            </select>
          </div>

            <label class="text-sm font-medium">Marca</label>
            <input id="pBrand" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Ej. Zara, Bershka" />
          </div>
        </div>
        <div class="space-y-3">
          <div>
            <label class="text-sm font-medium">Ciudad</label>
            <select required id="pCity" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300">
              <option>CDMX</option>
              <option>Guadalajara</option>
              <option>Monterrey</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Precio (MXN)</label>
            <input required type="number" min="1" id="pPrice" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Ej. 350" />
          </div>
          <!-- Subida de fotos con Cloudinary -->
          <div>
            <label class="text-sm font-medium">Fotos (hasta 4)</label>
            <div class="flex items-center gap-2">
              <button id="btnUpload" type="button" class="btn btn-ghost">Subir fotos</button>
              <span class="text-xs text-zinc-500">Desde tu cel o compu</span>
            </div>
            <div id="preview" class="mt-3 grid grid-cols-4 gap-2"></div>
            <p class="text-xs text-zinc-500 mt-1">Se guardan automáticamente en la nube y aquí solo vemos una vista previa.</p>
          </div>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm font-medium">Descripción</label>
          <textarea id="pDesc" rows="3" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Detalles, medidas, notas"></textarea>
        </div>
        <div class="md:col-span-2 flex items-center justify-end gap-3 pt-2">
          <button type="button" class="btn btn-ghost" onclick="closeModal('modalPublish')">Cancelar</button>
          <button class="btn btn-primary">Publicar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Comprar -->
  <div id="modalBuy" class="hidden fixed inset-0 z-50 bg-black/40 p-4 overflow-y-auto">
    <div class="max-w-lg mx-auto bg-white rounded-2xl p-6 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Confirmar compra</h3>
        <button class="text-zinc-500 hover:text-zinc-800" onclick="closeModal('modalBuy')">✕</button>
      </div>
      <div id="buySummary" class="text-sm text-zinc-700"></div>
      <div class="mt-4 space-y-2">
        <label class="text-sm font-medium">Método de entrega</label>
        <select id="buyDelivery" class="w-full px-3 py-2 rounded-xl border border-zinc-300">
          <option value="persona">Entrega en persona (recomendado)</option>
          <option value="envio">Envío por paquetería</option>
        </select>
      </div>
      <div id="shippingNote" class="mt-3 text-xs text-zinc-500 hidden">Para envío, el vendedor generará guía y te compartirá el rastreo. En fase 2 se auto‑creará con Skydropx.</div>
      <div class="mt-6 flex items-center justify-end gap-3">
        <button class="btn btn-ghost" onclick="closeModal('modalBuy')">Cancelar</button>
        <button id="btnPay" class="btn btn-primary">Pagar (simulado)</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Ajustes (perfil) -->
  <div id="modalSettings" class="hidden fixed inset-0 z-50 bg-black/40 p-4 overflow-y-auto">
    <div class="max-w-lg mx-auto bg-white rounded-2xl p-6 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Ajustes de cuenta</h3>
        <button class="text-zinc-500 hover:text-zinc-800" onclick="closeModal('modalSettings')">✕</button>
      </div>
      <form id="settingsForm" class="grid gap-3">
        <div>
          <label class="text-sm font-medium">Tu nombre (público)</label>
          <input id="sName" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Ej. Ana" />
        </div>
        <div>
          <label class="text-sm font-medium">Ciudad</label>
          <select id="sCity" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300">
            <option>CDMX</option>
            <option>Guadalajara</option>
            <option>Monterrey</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">WhatsApp (para entrega en persona)</label>
          <input id="sWhats" class="w-full mt-1 px-3 py-2 rounded-xl border border-zinc-300" placeholder="Ej. 55 1234 5678" />
        </div>
        <div class="flex items-center justify-end gap-3 pt-2">
          <button type="button" class="btn btn-ghost" onclick="closeModal('modalSettings')">Cancelar</button>
          <button class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: Admin -->
  <div id="modalAdmin" class="hidden fixed inset-0 z-50 bg-black/40 p-4 overflow-y-auto">
    <div class="max-w-3xl mx-auto bg-white rounded-2xl p-6 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold">Admin – Pedidos</h3>
        <button class="text-zinc-500 hover:text-zinc-800" onclick="closeModal('modalAdmin')">✕</button>
      </div>
      <div id="adminOrders" class="divide-y divide-zinc-200"></div>
    </div>
  </div>

  <script>
    // ====== Configura Cloudinary ======
    // 1) Crea cuenta en https://cloudinary.com/ (gratis)
    // 2) En Dashboard, copia tu cloud name
    // 3) Crea un Upload Preset SIN firmar (unsigned)
    // 4) Sustituye las constantes de abajo:
    const CLOUD_NAME = "diedjawe1"; 
    const UPLOAD_PRESET = "mujer_mvp";


    // LocalStorage helpers
    const ls = {
      get: (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d)),
      set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    };

    // Seed data (demo)
    const seedIfEmpty = () => {
      if (!localStorage.getItem('items')) {
        const demo = [
          { id: crypto.randomUUID(), sellerName: 'Ana', sellerWhats: '5512345678', city: 'CDMX', category: 'Ropa de mujer', subcat: 'Vestidos', title: 'Vestido midi floral', price: 320, size: 'M', condition: 'Casi nuevo', brand: 'Zara', description: 'Muy poco uso, corte midi.', images: ['https://images.unsplash.com/photo-1532536018-0d3e9a3e9f84?q=80&w=600&auto=format&fit=crop'], status: 'activo', createdAt: Date.now(), badges:['Vendedora fundadora'] },
          { id: crypto.randomUUID(), sellerName: 'Lu', sellerWhats: '5511122233', city: 'CDMX', category: 'Ropa de mujer', subcat: 'Tops', title: 'Top satinado', price: 180, size: 'S', condition: 'Uso leve', brand: '—', description: 'Ideal para noche.', images: ['https://images.unsplash.com/photo-1520975979642-6453be3f7070?q=80&w=600&auto=format&fit=crop'], status: 'activo', createdAt: Date.now() - 3600_000, badges:[] },
          { id: crypto.randomUUID(), sellerName: 'Mar', sellerWhats: '5599988877', city: 'CDMX', category: 'Ropa de mujer', subcat: 'Abrigos', title: 'Abrigo beige', price: 480, size: 'L', condition: 'Nuevo', brand: 'H&M', description: 'Calientito y ligero.', images: ['https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=600&auto=format&fit=crop'], status: 'activo', createdAt: Date.now() - 7200_000, badges:['Vendedora fundadora'] },
        ];
        ls.set('items', demo);
      }
      if (!localStorage.getItem('orders')) ls.set('orders', []);
      if (!localStorage.getItem('me')) ls.set('me', { name: 'Vendedora', city: 'CDMX', whats: '' });
    };

    let ITEMS = [];
    let ORDERS = [];
    let ME = {};
    let UPLOADED_IMAGES = [];

    function loadState() {
      ITEMS = ls.get('items', []);
      ORDERS = ls.get('orders', []);
      ME = ls.get('me', { name: 'Vendedora', city: 'CDMX', whats: '' });
      const name = document.getElementById('sName');
      if (name) name.value = ME.name || '';
      const city = document.getElementById('sCity');
      if (city) city.value = ME.city || 'CDMX';
      const whats = document.getElementById('sWhats');
      if (whats) whats.value = ME.whats || '';
    }

    function money(n){ return new Intl.NumberFormat('es-MX', { style:'currency', currency:'MXN' }).format(n); }
    function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id){ document.getElementById(id).classList.add('hidden'); }

    const grid = document.getElementById('grid');
    const emptyState = document.getElementById('emptyState');

    function renderGrid(){
      const sub = document.getElementById('filterSubcat').value;
      const cty = document.getElementById('filterCity').value;
      const ord = document.getElementById('filterOrder').value;
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      let list = ITEMS.filter(i => i.status === 'activo');
      if (sub) list = list.filter(i => i.subcat === sub);
      if (cty) list = list.filter(i => i.city === cty);
      if (q) list = list.filter(i => `${i.title} ${i.brand} ${i.description}`.toLowerCase().includes(q));
      if (ord === 'new') list.sort((a,b)=>b.createdAt - a.createdAt);
      if (ord === 'price_asc') list.sort((a,b)=>a.price - b.price);
      if (ord === 'price_desc') list.sort((a,b)=>b.price - a.price);

      grid.innerHTML = '';
      if (list.length === 0) { emptyState.classList.remove('hidden'); return; }
      emptyState.classList.add('hidden');

      list.forEach(i => {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-2xl shadow-sm overflow-hidden border border-zinc-200 flex flex-col';
        const img = (i.images && i.images[0]) || '';
        const badgeHtml = (i.badges||[]).map(b=>`<span class="chip">${b}</span>`).join(' ');
        card.innerHTML = `
          <div class="aspect-square bg-zinc-100 overflow-hidden">
            <img src="${img}" alt="${i.title}" class="w-full h-full object-cover" />
          </div>
          <div class="p-4 flex-1 flex flex-col">
            <div class="flex items-center justify-between gap-2">
              <h4 class="font-bold text-sm line-clamp-2">${i.title}</h4>
              <div class="text-xs text-zinc-500">${i.city}</div>
            </div>
            <p class="text-zinc-500 text-xs mt-1">${i.subcat} · ${i.brand || ''} · ${i.size || ''}</p>
            <p class="mt-2 font-extrabold">${money(i.price)}</p>
            ${badgeHtml ? `<div class="mt-2 flex gap-1">${badgeHtml}</div>` : ''}
            <p class="text-xs text-zinc-500 mt-1 line-clamp-3">${i.description || ''}</p>
            <div class="mt-auto pt-4 flex items-center gap-2">
              <button class="flex-1 btn btn-primary" onclick='openBuy("${i.id}")'>Comprar</button>
              <button class="btn btn-ghost" onclick='shareItem("${i.id}")'>Compartir</button>
            </div>
          </div>`;
        grid.appendChild(card);
      });
    }

    function shareItem(id){
      const item = ITEMS.find(i=>i.id===id);
      const url = location.href.split('#')[0] + `#item-${id}`;
      navigator.clipboard.writeText(`${item.title} – ${money(item.price)} ${url}`).then(()=>{
        alert('Copiado para compartir');
      });
    }

    // ====== Cloudinary Upload Widget ======
    let uploadWidget = null;
    function initUpload(){
      if (!CLOUD_NAME || CLOUD_NAME === 'TU_CLOUD_NAME') return alert('Configura CLOUD_NAME y UPLOAD_PRESET en el código.');
      uploadWidget = cloudinary.createUploadWidget({
        cloudName: CLOUD_NAME,
        uploadPreset: UPLOAD_PRESET,
        multiple: true,
        maxFiles: 4,
        sources: ['local','camera','url'],
        cropping: false,
        clientAllowedFormats: ['jpg','jpeg','png','webp'],
        maxImageFileSize: 8_000_000,
        folder: 'mujer_mvp'
      }, (error, result) => {
        if (!error && result && result.event === 'success') {
          if (UPLOADED_IMAGES.length >= 4) return;
          UPLOADED_IMAGES.push(result.info.secure_url);
          renderPreview();
        }
      });
    }

    function renderPreview(){
      const wrap = document.getElementById('preview');
      wrap.innerHTML = '';
      UPLOADED_IMAGES.forEach((u, idx)=>{
        const div = document.createElement('div');
        div.className = 'relative';
        div.innerHTML = `
          <img src="${u}" class="w-full h-20 object-cover rounded-lg border"/>
          <button class="absolute -top-2 -right-2 bg-white border rounded-full w-6 h-6 text-xs" data-idx="${idx}">✕</button>`;
        wrap.appendChild(div);
      });
      // botones de eliminar
      wrap.querySelectorAll('button[data-idx]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const i = Number(e.currentTarget.getAttribute('data-idx'));
          UPLOADED_IMAGES.splice(i,1);
          renderPreview();
        });
      });
    }

    // Publicar
    document.getElementById('publishForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if (UPLOADED_IMAGES.length === 0) { alert('Sube al menos una foto.'); return; }
      const i = {
        id: crypto.randomUUID(),
        sellerName: ME.name || 'Vendedora',
        sellerWhats: ME.whats || '',
        city: document.getElementById('pCity').value,
        category: 'Ropa de mujer',
        subcat: document.getElementById('pSubcat').value,
        title: document.getElementById('pTitle').value.trim(),
        price: Number(document.getElementById('pPrice').value),
        size: document.getElementById('pSize').value,
        condition: document.getElementById('pCondition').value,
        brand: document.getElementById('pBrand').value.trim(),
        description: document.getElementById('pDesc').value.trim(),
        images: [...UPLOADED_IMAGES],
        badges: [],
        status: 'activo',
        createdAt: Date.now()
      };
      ITEMS.unshift(i);
      ls.set('items', ITEMS);
      closeModal('modalPublish');
      UPLOADED_IMAGES = [];
      renderPreview();
      renderGrid();
      alert('Publicado ✅');
      e.target.reset();
    });

    // Comprar (simulado)
    let BUYING_ID = null;
    function openBuy(id){
      BUYING_ID = id;
      const it = ITEMS.find(i=>i.id===id);
      const sum = document.getElementById('buySummary');
      const img = (it.images && it.images[0]) || '';
      sum.innerHTML = `
        <div class="flex gap-3 items-center">
          <img src="${img}" class="w-16 h-16 object-cover rounded-lg border"/>
          <div>
            <div class="font-semibold">${it.title}</div>
            <div class="text-zinc-500 text-sm">${it.subcat} · ${it.brand || ''} · ${it.size || ''}</div>
            <div class="mt-1 font-extrabold">${money(it.price)}</div>
          </div>
        </div>`;
      document.getElementById('buyDelivery').value = 'persona';
      document.getElementById('shippingNote').classList.add('hidden');
      openModal('modalBuy');
    }
    window.openBuy = openBuy;

    document.getElementById('buyDelivery').addEventListener('change', (e)=>{
      if (e.target.value === 'envio') document.getElementById('shippingNote').classList.remove('hidden');
      else document.getElementById('shippingNote').classList.add('hidden');
    });

    document.getElementById('btnPay').addEventListener('click', ()=>{
      if (!BUYING_ID) return;
      const it = ITEMS.find(i=>i.id===BUYING_ID);
      const delivery = document.getElementById('buyDelivery').value;
      const order = {
        id: crypto.randomUUID(),
        productId: it.id,
        buyerName: 'Compradora',
        sellerName: it.sellerName,
        sellerWhats: it.sellerWhats,
        price: it.price,
        delivery,
        status: 'pagado',
        createdAt: Date.now(),
        tracking: ''
      };
      ORDERS.unshift(order);
      ls.set('orders', ORDERS);
      closeModal('modalBuy');
      alert('Pago simulado ✅. Coordina entrega en persona o espera la guía.');
    });

    // Ajustes
    document.getElementById('settingsForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      ME = {
        name: document.getElementById('sName').value.trim() || 'Vendedora',
        city: document.getElementById('sCity').value,
        whats: document.getElementById('sWhats').value.trim()
      };
      ls.set('me', ME);
      closeModal('modalSettings');
      alert('Guardado ✅');
    });

    // Admin
    function renderAdmin(){
      const wrap = document.getElementById('adminOrders');
      if (!ORDERS.length){ wrap.innerHTML = '<div class="py-8 text-sm text-zinc-500">Sin pedidos aún.</div>'; return; }
      wrap.innerHTML = ORDERS.map(o=>{
        const it = ITEMS.find(i=>i.id===o.productId) || {};
        const img = (it.images && it.images[0]) || '';
        return `
          <div class="py-4 flex flex-col md:flex-row md:items-center gap-3 justify-between">
            <div class="flex items-center gap-3">
              <img src="${img}" class="w-14 h-14 object-cover rounded-lg border"/>
              <div>
                <div class="font-medium">${it.title || ''}</div>
                <div class="text-xs text-zinc-500">${money(o.price)} · ${o.delivery==='persona'?'En persona':'Envío'}</div>
                <div class="text-xs text-zinc-500">Vendedora: ${o.sellerName || ''}</div>
              </div>
            </div>
            <div class="flex items-center gap-2 text-sm">
              <span class="chip">${o.status}</span>
              ${o.delivery==='envio' ? `
                <input id="trk-${o.id}" class="px-2 py-1 border rounded-lg" placeholder="# guía / rastreo" value="${o.tracking||''}">
                <button class="px-3 py-2 rounded-lg bg-zinc-100" onclick="saveTracking('${o.id}')">Guardar guía</button>
              `:''}
              ${o.status==='pagado' ? `<button class="px-3 py-2 rounded-lg bg-amber-100" onclick="advance('${o.id}','enviado')">Marcar enviado</button>`:''}
              ${o.status==='enviado' ? `<button class="px-3 py-2 rounded-lg bg-emerald-100" onclick="advance('${o.id}','entregado')">Marcar entregado</button>`:''}
              ${o.status==='entregado' ? `<button class="px-3 py-2 rounded-lg bg-zinc-900 text-white" onclick="advance('${o.id}','payout')">Liberar pago</button>`:''}
            </div>
          </div>`
      }).join('');
    }
    window.saveTracking = (id)=>{
      const idx = ORDERS.findIndex(o=>o.id===id);
      if (idx>=0){
        ORDERS[idx].tracking = document.getElementById('trk-'+id).value.trim();
        ls.set('orders', ORDERS);
        alert('Guía guardada ✅');
      }
    };
    window.advance = (id, next)=>{
      const idx = ORDERS.findIndex(o=>o.id===id);
      if (idx<0) return;
      if (next==='enviado') ORDERS[idx].status='enviado';
      if (next==='entregado') ORDERS[idx].status='entregado';
      if (next==='payout') { ORDERS[idx].status='pago_liberado';
        const pIdx = ITEMS.findIndex(i=>i.id===ORDERS[idx].productId);
        if (pIdx>=0){ ITEMS[pIdx].status='vendido'; ls.set('items', ITEMS); renderGrid(); }
      }
      ls.set('orders', ORDERS);
      renderAdmin();
      alert('Actualizado ✅');
    };

    // Nav
    document.getElementById('btnPublish').onclick = ()=>{ UPLOADED_IMAGES = []; renderPreview(); openModal('modalPublish'); };
    document.getElementById('btnMyAccount').onclick = ()=>openModal('modalSettings');
    document.getElementById('openSettings').onclick = (e)=>{ e.preventDefault(); openModal('modalSettings'); };
    document.getElementById('btnAdmin').onclick = ()=>{ renderAdmin(); openModal('modalAdmin'); };
    document.getElementById('btnFeed').onclick = ()=>window.scrollTo({ top: document.querySelector('main').offsetTop - 60, behavior: 'smooth' });
    document.getElementById('ctaExplorar').onclick = ()=>document.getElementById('btnFeed').onclick();
    document.getElementById('ctaPublicar').onclick = ()=>document.getElementById('btnPublish').onclick();

    // Filtros
    document.getElementById('filterSubcat').onchange = renderGrid;
    document.getElementById('filterCity').onchange = renderGrid;
    document.getElementById('filterOrder').onchange = renderGrid;
    document.getElementById('searchInput').oninput = ()=>{ renderGrid(); };
    document.getElementById('clearFilters').onclick = ()=>{
      document.getElementById('filterSubcat').value='';
      document.getElementById('filterCity').value='';
      document.getElementById('filterOrder').value='new';
      document.getElementById('searchInput').value='';
      renderGrid();
    };

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();
    seedIfEmpty();
    loadState();
    renderGrid();

    // Inicializa Cloudinary y botón de subir
    initUpload();
    document.getElementById('btnUpload').addEventListener('click', ()=>{
      if (!uploadWidget) initUpload();
      if (uploadWidget) uploadWidget.open();
    });
  </script>
</body>
</html>

